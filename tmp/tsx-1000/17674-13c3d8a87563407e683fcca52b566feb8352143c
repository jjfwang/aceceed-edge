{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{promises as fs}from\"node:fs\";class OpenAiWhisperStt{constructor(config,logger){this.config=config;this.logger=logger}static{__name(this,\"OpenAiWhisperStt\")}async transcribe(audioPath){const cloud=this.config.cloud;if(!cloud){throw new Error(\"Cloud STT configured without provider details\")}const apiKey=process.env[cloud.apiKeyEnv];if(!apiKey){throw new Error(`Missing API key in env ${cloud.apiKeyEnv}`)}const baseUrl=cloud.baseUrl??\"https://api.openai.com/v1\";const normalizedBase=baseUrl.endsWith(\"/\")?baseUrl:`${baseUrl}/`;const url=new URL(\"audio/transcriptions\",normalizedBase);const model=cloud.model??\"whisper-1\";const timeoutMs=2e4;const retries=2;const audioBuffer=await fs.readFile(audioPath);let lastError;for(let attempt=0;attempt<=retries;attempt++){const controller=new AbortController;const timer=setTimeout(()=>controller.abort(),timeoutMs);try{const form=new FormData;form.set(\"model\",model);form.set(\"file\",new Blob([audioBuffer],{type:\"audio/wav\"}),\"audio.wav\");const response=await fetch(url,{method:\"POST\",headers:{Authorization:`Bearer ${apiKey}`},body:form,signal:controller.signal});clearTimeout(timer);if(!response.ok){const body=await response.text();throw new Error(`OpenAI API error: ${response.status} ${body}`)}const data=await response.json();const transcript=data.text?.trim()??\"\";if(!transcript){this.logger.warn(\"Empty transcript from OpenAI Whisper\")}return transcript}catch(err){clearTimeout(timer);lastError=err;if(attempt===retries){break}const backoffMs=200*Math.pow(2,attempt);await new Promise(resolve=>setTimeout(resolve,backoffMs))}}throw lastError??new Error(\"OpenAI STT request failed\")}}export{OpenAiWhisperStt};\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,OAAS,YAAY,OAAU,UASxB,MAAM,gBAAwC,CACnD,YAAoB,OAA2B,OAAgB,CAA3C,mBAA2B,kBAAiB,CAVlE,MASqD,iCAGnD,MAAM,WAAW,UAAoC,CACnD,MAAM,MAAQ,KAAK,OAAO,MAC1B,GAAI,CAAC,MAAO,CACV,MAAM,IAAI,MAAM,+CAA+C,CACjE,CAEA,MAAM,OAAS,QAAQ,IAAI,MAAM,SAAS,EAC1C,GAAI,CAAC,OAAQ,CACX,MAAM,IAAI,MAAM,0BAA0B,MAAM,SAAS,EAAE,CAC7D,CAEA,MAAM,QAAU,MAAM,SAAW,4BACjC,MAAM,eAAiB,QAAQ,SAAS,GAAG,EAAI,QAAU,GAAG,OAAO,IACnE,MAAM,IAAM,IAAI,IAAI,uBAAwB,cAAc,EAC1D,MAAM,MAAQ,MAAM,OAAS,YAC7B,MAAM,UAAY,IAClB,MAAM,QAAU,EAEhB,MAAM,YAAc,MAAM,GAAG,SAAS,SAAS,EAE/C,IAAI,UACJ,QAAS,QAAU,EAAG,SAAW,QAAS,UAAW,CACnD,MAAM,WAAa,IAAI,gBACvB,MAAM,MAAQ,WAAW,IAAM,WAAW,MAAM,EAAG,SAAS,EAC5D,GAAI,CACF,MAAM,KAAO,IAAI,SACjB,KAAK,IAAI,QAAS,KAAK,EACvB,KAAK,IAAI,OAAQ,IAAI,KAAK,CAAC,WAAW,EAAG,CAAE,KAAM,WAAY,CAAC,EAAG,WAAW,EAE5E,MAAM,SAAW,MAAM,MAAM,IAAK,CAChC,OAAQ,OACR,QAAS,CAAE,cAAe,UAAU,MAAM,EAAG,EAC7C,KAAM,KACN,OAAQ,WAAW,MACrB,CAAC,EAED,aAAa,KAAK,EAElB,GAAI,CAAC,SAAS,GAAI,CAChB,MAAM,KAAO,MAAM,SAAS,KAAK,EACjC,MAAM,IAAI,MAAM,qBAAqB,SAAS,MAAM,IAAI,IAAI,EAAE,CAChE,CAEA,MAAM,KAAQ,MAAM,SAAS,KAAK,EAClC,MAAM,WAAa,KAAK,MAAM,KAAK,GAAK,GACxC,GAAI,CAAC,WAAY,CACf,KAAK,OAAO,KAAK,sCAAsC,CACzD,CACA,OAAO,UACT,OAAS,IAAK,CACZ,aAAa,KAAK,EAClB,UAAY,IACZ,GAAI,UAAY,QAAS,CACvB,KACF,CACA,MAAM,UAAY,IAAM,KAAK,IAAI,EAAG,OAAO,EAC3C,MAAM,IAAI,QAAS,SAAY,WAAW,QAAS,SAAS,CAAC,CAC/D,CACF,CAEA,MAAM,WAAa,IAAI,MAAM,2BAA2B,CAC1D,CACF","names":[],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/audio/stt/openaiWhisper.ts"],"sourcesContent":[null]}}