{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});function detectResponseLanguage(transcript){if(/[\\u4E00-\\u9FFF]/.test(transcript)){return{label:\"Simplified Chinese\"}}if(/[\\u3040-\\u30FF]/.test(transcript)){return{label:\"Japanese\"}}if(/[\\uAC00-\\uD7AF]/.test(transcript)){return{label:\"Korean\"}}return null}__name(detectResponseLanguage,\"detectResponseLanguage\");function stripLanguagePrefix(response){const trimmed=response.trim();const patterns=[/^here(?:'s| is)\\s+(?:the\\s+)?answer\\s+in\\s+\\w+\\s*[:：]\\s*/i,/^answer\\s*[:：]\\s*/i,/^response\\s*[:：]\\s*/i,/^final\\s*[:：]\\s*/i,/^回复\\s*[:：]\\s*/i,/^回答\\s*[:：]\\s*/i,/^答复\\s*[:：]\\s*/i,/^答案\\s*[:：]\\s*/i,/^答\\s*[:：]\\s*/i];for(const pattern of patterns){if(pattern.test(trimmed)){return trimmed.replace(pattern,\"\").trim()}}return trimmed}__name(stripLanguagePrefix,\"stripLanguagePrefix\");function buildSystemPrompt(base,language){if(!language){return base}return[base,`Respond only in ${language}. Do not translate or switch languages.`,\"Do not add prefatory labels like 'Answer:' or language names.\"].filter(Boolean).join(\"\\n\")}__name(buildSystemPrompt,\"buildSystemPrompt\");function responseMatchesLanguage(response,language){if(language===\"Simplified Chinese\"){return/[\\u4E00-\\u9FFF]/.test(response)}if(language===\"Japanese\"){return/[\\u3040-\\u30FF]/.test(response)}if(language===\"Korean\"){return/[\\uAC00-\\uD7AF]/.test(response)}return true}__name(responseMatchesLanguage,\"responseMatchesLanguage\");function buildTranslationMessages(text,language){return[{role:\"system\",content:`Translate the text into ${language}. Output only the translation.`},{role:\"user\",content:text}]}__name(buildTranslationMessages,\"buildTranslationMessages\");function buildCurriculumContext(input){const lines=[];if(input.gradeBand){lines.push(`You are helping a Singapore ${input.gradeBand} student.`)}if(input.subjects&&input.subjects.length>0){lines.push(`The focus subjects are: ${input.subjects.join(\", \")}.`)}if(input.ragChunks&&input.ragChunks.length>0){lines.push(\"Use the following syllabus-aligned references first:\");for(const chunk of input.ragChunks){const sourceLabel=chunk.source?` (source: ${chunk.source})`:\"\";const sourceType=chunk.sourceType?`[${chunk.sourceType}] `:\"\";lines.push(`- ${sourceType}${chunk.subject}/${chunk.topic}: ${chunk.content}${sourceLabel}`)}}if(input.ocrText){lines.push(`Student work (OCR): ${input.ocrText}`)}if(!lines.length){return null}return lines.join(\"\\n\")}__name(buildCurriculumContext,\"buildCurriculumContext\");class TutorAgent{constructor(llm,systemPrompt,logger){this.llm=llm;this.systemPrompt=systemPrompt;this.logger=logger}static{__name(this,\"TutorAgent\")}id=\"tutor\";name=\"Tutor\";async handle(input){if(!input.transcript.trim()){return null}const languageHint=detectResponseLanguage(input.transcript);const finalPrompt=buildSystemPrompt(this.systemPrompt,languageHint?.label??null);const curriculumContext=buildCurriculumContext(input);const messages=[{role:\"system\",content:finalPrompt},...curriculumContext?[{role:\"system\",content:curriculumContext}]:[],{role:\"user\",content:input.transcript}];if(this.logger){this.logger.info({messages},\"LLM request\")}const response=await this.llm.generate(messages);if(this.logger){this.logger.info({response},\"LLM response\")}let finalResponse=response;if(languageHint&&!responseMatchesLanguage(response,languageHint.label)){if(this.logger){this.logger.info({target:languageHint.label},\"LLM response language mismatch, retrying with translation\")}const translated=await this.llm.generate(buildTranslationMessages(response,languageHint.label));if(responseMatchesLanguage(translated,languageHint.label)){finalResponse=translated}}return{text:stripLanguagePrefix(finalResponse)}}}export{TutorAgent};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/agents/tutorAgent.ts"],"sourcesContent":[null]}}