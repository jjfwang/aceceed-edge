{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{promises as fs}from\"node:fs\";import{runCommand,tempPath}from\"../../common/utils.js\";function detectLanguageTag(text){if(/[\\u4E00-\\u9FFF]/.test(text)){return\"zh\"}if(/[\\u3040-\\u30FF]/.test(text)){return\"ja\"}if(/[\\uAC00-\\uD7AF]/.test(text)){return\"ko\"}return\"en\"}__name(detectLanguageTag,\"detectLanguageTag\");function findVoice(voiceByLang,language){if(!voiceByLang){return null}const direct=voiceByLang[language];if(direct){return direct}const base=language.split(\"-\")[0];if(base!==language&&voiceByLang[base]){return voiceByLang[base]}return null}__name(findVoice,\"findVoice\");class PiperTts{constructor(config,logger){this.config=config;this.logger=logger}static{__name(this,\"PiperTts\")}async synthesize(text){const language=detectLanguageTag(text);const mappedVoice=findVoice(this.config.piper.voiceByLang,language);const useChinese=language===\"zh\";const voicePath=mappedVoice?.voicePath??(useChinese&&this.config.piper.voicePathZh?this.config.piper.voicePathZh:this.config.piper.voicePath);const outputSampleRate=mappedVoice?.outputSampleRate??(useChinese&&this.config.piper.outputSampleRateZh?this.config.piper.outputSampleRateZh:this.config.piper.outputSampleRate);if(useChinese&&!mappedVoice&&!this.config.piper.voicePathZh){this.logger.warn(\"Chinese text detected but no Chinese Piper voice configured.\")}const outputPath=tempPath(\"piper\",\".wav\");const args=[\"--model\",voicePath,\"--output_file\",outputPath,\"--output_sample_rate\",String(outputSampleRate)];try{await runCommand(this.config.piper.binPath,args,{input:text})}catch(err){throw new Error(`Piper failed. Check binPath '${this.config.piper.binPath}' and voicePath '${this.config.piper.voicePath}'.`)}const wavBuffer=await fs.readFile(outputPath);if(wavBuffer.length<28){throw new Error(\"Piper produced an invalid WAV file\")}const sampleRate=wavBuffer.readUInt32LE(24);if(sampleRate!==outputSampleRate){throw new Error(`Piper output sample rate ${sampleRate}Hz does not match configured ${outputSampleRate}Hz.`)}return outputPath}}export{PiperTts};\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,OAAS,YAAY,OAAU,UAG/B,OAAS,WAAY,aAAgB,wBAGrC,SAAS,kBAAkB,KAAsB,CAC/C,GAAI,kBAAkB,KAAK,IAAI,EAAG,CAChC,MAAO,IACT,CACA,GAAI,kBAAkB,KAAK,IAAI,EAAG,CAChC,MAAO,IACT,CACA,GAAI,kBAAkB,KAAK,IAAI,EAAG,CAChC,MAAO,IACT,CACA,MAAO,IACT,CAXS,8CAaT,SAAS,UACP,YACA,SACyD,CACzD,GAAI,CAAC,YAAa,CAChB,OAAO,IACT,CACA,MAAM,OAAS,YAAY,QAAQ,EACnC,GAAI,OAAQ,CACV,OAAO,MACT,CACA,MAAM,KAAO,SAAS,MAAM,GAAG,EAAE,CAAC,EAClC,GAAI,OAAS,UAAY,YAAY,IAAI,EAAG,CAC1C,OAAO,YAAY,IAAI,CACzB,CACA,OAAO,IACT,CAhBS,8BAkBF,MAAM,QAAgC,CAC3C,YAAoB,OAA2B,OAAgB,CAA3C,mBAA2B,kBAAiB,CAtClE,MAqC6C,yBAG3C,MAAM,WAAW,KAA+B,CAC9C,MAAM,SAAW,kBAAkB,IAAI,EACvC,MAAM,YAAc,UAAU,KAAK,OAAO,MAAM,YAAa,QAAQ,EACrE,MAAM,WAAa,WAAa,KAChC,MAAM,UAAY,aAAa,YACzB,YAAc,KAAK,OAAO,MAAM,YAChC,KAAK,OAAO,MAAM,YAClB,KAAK,OAAO,MAAM,WACxB,MAAM,iBAAmB,aAAa,mBAChC,YAAc,KAAK,OAAO,MAAM,mBAChC,KAAK,OAAO,MAAM,mBAClB,KAAK,OAAO,MAAM,kBACxB,GAAI,YAAc,CAAC,aAAe,CAAC,KAAK,OAAO,MAAM,YAAa,CAChE,KAAK,OAAO,KAAK,8DAA8D,CACjF,CACA,MAAM,WAAa,SAAS,QAAS,MAAM,EAE3C,MAAM,KAAO,CACX,UACA,UACA,gBACA,WACA,uBACA,OAAO,gBAAgB,CACzB,EAEA,GAAI,CACF,MAAM,WAAW,KAAK,OAAO,MAAM,QAAS,KAAM,CAAE,MAAO,IAAK,CAAC,CACnE,OAAS,IAAK,CACZ,MAAM,IAAI,MACR,gCAAgC,KAAK,OAAO,MAAM,OAAO,oBAAoB,KAAK,OAAO,MAAM,SAAS,IAC1G,CACF,CAEA,MAAM,UAAY,MAAM,GAAG,SAAS,UAAU,EAC9C,GAAI,UAAU,OAAS,GAAI,CACzB,MAAM,IAAI,MAAM,oCAAoC,CACtD,CACA,MAAM,WAAa,UAAU,aAAa,EAAE,EAC5C,GAAI,aAAe,iBAAkB,CACnC,MAAM,IAAI,MACR,4BAA4B,UAAU,gCAAgC,gBAAgB,KACxF,CACF,CAEA,OAAO,UACT,CACF","names":[],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/audio/tts/piper.ts"],"sourcesContent":[null]}}