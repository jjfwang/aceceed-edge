{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{spawn,spawnSync}from\"node:child_process\";const boardToBcmMap={3:2,5:3,7:4,8:14,10:15,11:17,12:18,13:27,15:22,16:23,18:24,19:10,21:9,22:25,23:11,24:8,26:7,29:5,31:6,32:12,33:13,35:19,36:16,37:26,38:20,40:21};function resolveBcmPin(boardPin,logger){const bcmPin=boardToBcmMap[boardPin];if(bcmPin!==void 0){return bcmPin}logger.warn({boardPin},\"Unknown BOARD pin. Treating value as BCM pin.\");return boardPin}__name(resolveBcmPin,\"resolveBcmPin\");function canUseGpiomon(){const result=spawnSync(\"gpiomon\",[\"--help\"],{stdio:\"ignore\"});if(!result.error){return true}return result.error.code!==\"ENOENT\"}__name(canUseGpiomon,\"canUseGpiomon\");function parseEdge(line){const trimmed=line.trim().toLowerCase();if(trimmed===\"rising\"||trimmed.includes(\"rising\")){return\"rising\"}if(trimmed===\"falling\"||trimmed.includes(\"falling\")){return\"falling\"}return null}__name(parseEdge,\"parseEdge\");function startWhisplayPttWithGpiomon(bus,logger,bcmPin,boardPin,mode,bounceMs){if(!canUseGpiomon()){return null}const args=[\"-c\",\"gpiochip0\",\"-e\",\"both\",\"-F\",\"%E\",\"-p\",`${bounceMs}ms`,String(bcmPin)];const child=spawn(\"gpiomon\",args,{stdio:[\"ignore\",\"pipe\",\"pipe\"]});let pressed=false;let toggled=false;let lastEventMs=0;let buffer=\"\";const handleEdge=__name(edge=>{const now=Date.now();if(now-lastEventMs<bounceMs){return}lastEventMs=now;if(mode===\"toggle\"){if(edge===\"rising\"){toggled=!toggled;bus.publish({type:toggled?\"ptt:start\":\"ptt:stop\",source:\"whisplay\"})}return}if(edge===\"rising\"&&!pressed){pressed=true;bus.publish({type:\"ptt:start\",source:\"whisplay\"});return}if(edge===\"falling\"&&pressed){pressed=false;bus.publish({type:\"ptt:stop\",source:\"whisplay\"})}},\"handleEdge\");child.stdout?.on(\"data\",data=>{buffer+=data.toString();const lines=buffer.split(/\\r?\\n/);buffer=lines.pop()??\"\";for(const line of lines){const edge=parseEdge(line);if(edge){handleEdge(edge)}}});child.stderr?.on(\"data\",data=>{const text=data.toString().trim();if(text){logger.warn({output:text},\"Whisplay PTT gpiomon stderr\")}});child.on(\"error\",err=>{logger.warn({err},\"Whisplay PTT gpiomon failed to start.\")});child.on(\"exit\",(code,signal)=>{logger.warn({code,signal},\"Whisplay PTT gpiomon exited.\")});logger.info({boardPin,bcmPin,mode,bounceMs},\"Whisplay PTT listening via gpiomon.\");return()=>{if(!child.killed){child.kill(\"SIGTERM\")}}}__name(startWhisplayPttWithGpiomon,\"startWhisplayPttWithGpiomon\");async function startWhisplayPttWithOnoff(bus,logger,bcmPin,boardPin,mode,bounceMs){let Gpio;try{const onoffModule=await import(\"onoff\").then(s=>{const e=\"default\";return s[e]&&typeof s[e]==\"object\"&&\"__esModule\"in s[e]?s[e]:s});Gpio=onoffModule.Gpio}catch(err){logger.warn({err},\"Whisplay PTT unavailable: failed to load onoff.\");return null}if(!Gpio){logger.warn(\"Whisplay PTT unavailable: onoff.Gpio not found.\");return null}let pressed=false;let toggled=false;let gpio;try{gpio=new Gpio(bcmPin,\"in\",\"both\",{debounceTimeout:bounceMs,activeLow:false})}catch(err){logger.warn({err},\"Whisplay PTT failed to initialize GPIO.\");return null}gpio.watch((err,value)=>{if(err){logger.warn({err},\"Whisplay PTT GPIO error.\");return}if(mode===\"toggle\"){if(value===1){toggled=!toggled;bus.publish({type:toggled?\"ptt:start\":\"ptt:stop\",source:\"whisplay\"})}return}if(value===1&&!pressed){pressed=true;bus.publish({type:\"ptt:start\",source:\"whisplay\"});return}if(value===0&&pressed){pressed=false;bus.publish({type:\"ptt:stop\",source:\"whisplay\"})}});logger.info({boardPin,bcmPin,mode,bounceMs},\"Whisplay PTT listening via onoff.\");return()=>{gpio.unwatchAll();gpio.unexport()}}__name(startWhisplayPttWithOnoff,\"startWhisplayPttWithOnoff\");async function startWhisplayPtt(bus,config,logger){if(process.platform!==\"linux\"){logger.warn(\"Whisplay PTT is only supported on Linux.\");return()=>void 0}const whisplay=config.runtime.whisplay;const boardPin=whisplay?.buttonPin??11;const bcmPin=resolveBcmPin(boardPin,logger);if(!Number.isInteger(bcmPin)||bcmPin<0){logger.warn({boardPin},\"Whisplay PTT disabled: invalid button pin.\");return()=>void 0}const bounceMs=whisplay?.bounceMs??50;const mode=whisplay?.mode??\"hold\";const gpiomonStop=startWhisplayPttWithGpiomon(bus,logger,bcmPin,boardPin,mode,bounceMs);if(gpiomonStop){return gpiomonStop}const onoffStop=await startWhisplayPttWithOnoff(bus,logger,bcmPin,boardPin,mode,bounceMs);if(onoffStop){return onoffStop}logger.warn(\"Whisplay PTT unavailable: no GPIO backend succeeded.\");return()=>void 0}__name(startWhisplayPtt,\"startWhisplayPtt\");export{startWhisplayPtt};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/runtime/whisplayPtt.ts"],"sourcesContent":[null]}}