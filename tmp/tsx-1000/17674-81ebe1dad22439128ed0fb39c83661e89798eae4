{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});function buildPrompt(messages){const systemPrompt=messages.filter(msg=>msg.role===\"system\").map(msg=>msg.content).join(\"\\n\").trim();const dialogue=messages.filter(msg=>msg.role!==\"system\");const userMessages=dialogue.filter(msg=>msg.role===\"user\");const hasAssistant=dialogue.some(msg=>msg.role===\"assistant\");const prompt=userMessages.length===1&&!hasAssistant?userMessages[0].content.trim():dialogue.map(msg=>{const label=msg.role===\"assistant\"?\"Assistant\":\"User\";return`${label}: ${msg.content}`}).join(\"\\n\").trim();return{systemPrompt:systemPrompt||void 0,prompt}}__name(buildPrompt,\"buildPrompt\");function stripThinking(text){return text.replace(/<think>[\\s\\S]*?<\\/think>/g,\"\").replace(/<\\/think>/g,\"\").trim()}__name(stripThinking,\"stripThinking\");class Llm8850Client{constructor(config,logger){this.config=config;this.logger=logger}static{__name(this,\"Llm8850Client\")}async generate(messages){const llmConfig=this.config.local.llm8850;if(!llmConfig?.host){throw new Error(\"LLM-8850 host is not configured. Set llm.local.llm8850.host.\")}const{systemPrompt,prompt}=buildPrompt(messages);if(!prompt){return\"\"}const baseUrl=llmConfig.host;const temperature=llmConfig.temperature??this.config.local.temperature;const timeoutMs=llmConfig.requestTimeoutMs??1e4;const pollIntervalMs=llmConfig.pollIntervalMs??200;const maxWaitMs=llmConfig.maxWaitMs??6e4;const enableThinking=llmConfig.enableThinking??true;const resetOnRequest=llmConfig.resetOnRequest??true;if(resetOnRequest&&systemPrompt){const resetPayload={system_prompt:enableThinking?systemPrompt:`${systemPrompt} /no_think`};await this.fetchJson(new URL(\"/api/reset\",baseUrl),{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify(resetPayload)},timeoutMs)}const generatePayload={prompt,temperature};if(llmConfig.topK!==void 0){generatePayload[\"top-k\"]=llmConfig.topK}await this.fetchJson(new URL(\"/api/generate\",baseUrl),{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify(generatePayload)},timeoutMs);const deadline=Date.now()+maxWaitMs;let responseText=\"\";while(Date.now()<deadline){const data=await this.fetchJson(new URL(\"/api/generate_provider\",baseUrl),{method:\"GET\"},timeoutMs);if(data.done){responseText=data.response??\"\";break}await new Promise(resolve=>setTimeout(resolve,pollIntervalMs))}if(!responseText){if(Date.now()>=deadline){throw new Error(\"LLM-8850 response timed out.\")}this.logger.warn(\"Empty response from LLM-8850\");return\"\"}return enableThinking?responseText.trim():stripThinking(responseText)}async fetchJson(url,init,timeoutMs){const controller=new AbortController;const timer=setTimeout(()=>controller.abort(),timeoutMs);try{const response=await fetch(url,{...init,signal:controller.signal});clearTimeout(timer);if(!response.ok){const body=await response.text();throw new Error(`LLM-8850 API error: ${response.status} ${body}`)}try{return await response.json()}catch{return{}}}catch(err){clearTimeout(timer);if(err instanceof Error){if(err.message.startsWith(\"LLM-8850 API error\")){throw err}if(err.name===\"AbortError\"){throw new Error(`LLM-8850 request timed out after ${timeoutMs}ms`)}}throw new Error(`Unable to reach LLM-8850 at ${url.origin}. Is the service running?`)}}}export{Llm8850Client};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/llm/llm8850Api.ts"],"sourcesContent":[null]}}