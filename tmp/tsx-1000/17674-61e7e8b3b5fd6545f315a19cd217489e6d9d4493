{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{spawn}from\"node:child_process\";import{existsSync}from\"node:fs\";import net from\"node:net\";import path from\"node:path\";const scriptCandidates=[path.resolve(process.cwd(),\"scripts/whisplay_display.py\"),path.resolve(process.cwd(),\"../scripts/whisplay_display.py\")];function resolveScriptPath(){for(const candidate of scriptCandidates){if(existsSync(candidate)){return candidate}}return null}__name(resolveScriptPath,\"resolveScriptPath\");function startWhisplayDisplay(bus,config,logger){if(process.platform!==\"linux\"){return()=>void 0}if(config.runtime.pushToTalkMode!==\"whisplay\"){return()=>void 0}const scriptPath=resolveScriptPath();if(!scriptPath){logger.warn(\"Whisplay display script not found.\");return()=>void 0}let current;let client;let connecting=false;let reconnectTimer;const pending=[];const spawnDisplay=__name(()=>{const child=spawn(\"python3\",[scriptPath],{stdio:[\"ignore\",\"pipe\",\"pipe\"],env:{...process.env,PYTHONNOUSERSITE:\"1\",PYTHONUNBUFFERED:\"1\",WHISPLAY_SOCKET:\"1\",WHISPLAY_HOST:\"127.0.0.1\",WHISPLAY_PORT:\"12345\",WHISPLAY_SKIP_BUTTON:\"1\",WHISPLAY_BRIGHTNESS:\"60\"}});child.stdout?.on(\"data\",data=>{const output=data.toString().trim();if(output){logger.info({output},\"Whisplay display output\")}});child.stderr?.on(\"data\",data=>{const output=data.toString().trim();if(output){logger.warn({output},\"Whisplay display error\")}});child.on(\"exit\",()=>{if(current===child){current=void 0}});return child},\"spawnDisplay\");const scheduleReconnect=__name(()=>{if(reconnectTimer){return}reconnectTimer=setTimeout(()=>{reconnectTimer=void 0;connectClient()},500)},\"scheduleReconnect\");const flushQueue=__name(()=>{if(!client||client.destroyed){return}while(pending.length>0){const payload=pending.shift();if(payload){client.write(payload)}}},\"flushQueue\");const connectClient=__name(()=>{if(client&&!client.destroyed){return}if(connecting){return}connecting=true;const socket=new net.Socket;socket.on(\"connect\",()=>{connecting=false;client=socket;flushQueue()});socket.on(\"error\",err=>{logger.warn({err},\"Whisplay display socket error\");socket.destroy();if(client===socket){client=void 0}connecting=false;scheduleReconnect()});socket.on(\"close\",()=>{if(client===socket){client=void 0}connecting=false;scheduleReconnect()});socket.connect(12345,\"127.0.0.1\")},\"connectClient\");const render=__name((status,text)=>{const sanitized=text.replace(/\\s+/g,\" \").trim();if(!sanitized&&!status){return}if(!current||current.killed){current=spawnDisplay()}connectClient();const payload=JSON.stringify({status:status??void 0,text:sanitized});const line=`${payload}\n`;if(client&&!client.destroyed){client.write(line)}else{if(pending.length>10){pending.shift()}pending.push(line)}},\"render\");const handler=__name(event=>{if(event.type===\"ptt:start\"){render(\"listening\",\"\");return}if(event.type===\"ptt:stop\"){render(\"processing\",\"\");return}if(event.type===\"agent:response\"){render(null,event.text);return}if(event.type===\"tts:spoken\"){render(null,event.text);return}if(event.type===\"error\"){render(\"error\",event.message)}},\"handler\");bus.on(\"event\",handler);logger.info({scriptPath},\"Whisplay display enabled.\");return()=>{bus.off(\"event\",handler);if(current&&!current.killed){current.kill(\"SIGTERM\")}if(client&&!client.destroyed){client.destroy();client=void 0}if(reconnectTimer){clearTimeout(reconnectTimer);reconnectTimer=void 0}}}__name(startWhisplayDisplay,\"startWhisplayDisplay\");export{startWhisplayDisplay};\n","warnings":[],"map":{"version":3,"mappings":"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","names":[],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/runtime/whisplayDisplay.ts"],"sourcesContent":[null]}}