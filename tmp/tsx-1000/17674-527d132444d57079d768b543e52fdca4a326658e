{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{promises as fs}from\"node:fs\";import{tempPath}from\"../../common/utils.js\";class OpenAiTts{constructor(config,logger){this.config=config;this.logger=logger}static{__name(this,\"OpenAiTts\")}async synthesize(text){const cloud=this.config.cloud;if(!cloud){throw new Error(\"Cloud TTS configured without provider details\")}const apiKey=process.env[cloud.apiKeyEnv];if(!apiKey){throw new Error(`Missing API key in env ${cloud.apiKeyEnv}`)}const baseUrl=cloud.baseUrl??\"https://api.openai.com/v1\";const normalizedBase=baseUrl.endsWith(\"/\")?baseUrl:`${baseUrl}/`;const url=new URL(\"audio/speech\",normalizedBase);const model=cloud.model??\"tts-1\";const voice=cloud.voiceId??\"alloy\";const timeoutMs=2e4;const retries=2;let lastError;for(let attempt=0;attempt<=retries;attempt++){const controller=new AbortController;const timer=setTimeout(()=>controller.abort(),timeoutMs);try{const response=await fetch(url,{method:\"POST\",headers:{\"Content-Type\":\"application/json\",Authorization:`Bearer ${apiKey}`},body:JSON.stringify({model,voice,input:text,response_format:\"wav\"}),signal:controller.signal});clearTimeout(timer);if(!response.ok){const body=await response.text();throw new Error(`OpenAI API error: ${response.status} ${body}`)}const audio=Buffer.from(await response.arrayBuffer());if(audio.length===0){this.logger.warn(\"Empty audio response from OpenAI TTS\")}const outputPath=tempPath(\"openai-tts\",\".wav\");await fs.writeFile(outputPath,audio);return outputPath}catch(err){clearTimeout(timer);lastError=err;if(attempt===retries){break}const backoffMs=200*Math.pow(2,attempt);await new Promise(resolve=>setTimeout(resolve,backoffMs))}}throw lastError??new Error(\"OpenAI TTS request failed\")}}export{OpenAiTts};\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,OAAS,YAAY,OAAU,UAG/B,OAAS,aAAgB,wBAGlB,MAAM,SAAiC,CAC5C,YAAoB,OAA2B,OAAgB,CAA3C,mBAA2B,kBAAiB,CAPlE,MAM8C,0BAG5C,MAAM,WAAW,KAA+B,CAC9C,MAAM,MAAQ,KAAK,OAAO,MAC1B,GAAI,CAAC,MAAO,CACV,MAAM,IAAI,MAAM,+CAA+C,CACjE,CAEA,MAAM,OAAS,QAAQ,IAAI,MAAM,SAAS,EAC1C,GAAI,CAAC,OAAQ,CACX,MAAM,IAAI,MAAM,0BAA0B,MAAM,SAAS,EAAE,CAC7D,CAEA,MAAM,QAAU,MAAM,SAAW,4BACjC,MAAM,eAAiB,QAAQ,SAAS,GAAG,EAAI,QAAU,GAAG,OAAO,IACnE,MAAM,IAAM,IAAI,IAAI,eAAgB,cAAc,EAClD,MAAM,MAAQ,MAAM,OAAS,QAC7B,MAAM,MAAQ,MAAM,SAAW,QAC/B,MAAM,UAAY,IAClB,MAAM,QAAU,EAEhB,IAAI,UACJ,QAAS,QAAU,EAAG,SAAW,QAAS,UAAW,CACnD,MAAM,WAAa,IAAI,gBACvB,MAAM,MAAQ,WAAW,IAAM,WAAW,MAAM,EAAG,SAAS,EAC5D,GAAI,CACF,MAAM,SAAW,MAAM,MAAM,IAAK,CAChC,OAAQ,OACR,QAAS,CACP,eAAgB,mBAChB,cAAe,UAAU,MAAM,EACjC,EACA,KAAM,KAAK,UAAU,CACnB,MACA,MACA,MAAO,KACP,gBAAiB,KACnB,CAAC,EACD,OAAQ,WAAW,MACrB,CAAC,EAED,aAAa,KAAK,EAElB,GAAI,CAAC,SAAS,GAAI,CAChB,MAAM,KAAO,MAAM,SAAS,KAAK,EACjC,MAAM,IAAI,MAAM,qBAAqB,SAAS,MAAM,IAAI,IAAI,EAAE,CAChE,CAEA,MAAM,MAAQ,OAAO,KAAK,MAAM,SAAS,YAAY,CAAC,EACtD,GAAI,MAAM,SAAW,EAAG,CACtB,KAAK,OAAO,KAAK,sCAAsC,CACzD,CAEA,MAAM,WAAa,SAAS,aAAc,MAAM,EAChD,MAAM,GAAG,UAAU,WAAY,KAAK,EACpC,OAAO,UACT,OAAS,IAAK,CACZ,aAAa,KAAK,EAClB,UAAY,IACZ,GAAI,UAAY,QAAS,CACvB,KACF,CACA,MAAM,UAAY,IAAM,KAAK,IAAI,EAAG,OAAO,EAC3C,MAAM,IAAI,QAAS,SAAY,WAAW,QAAS,SAAS,CAAC,CAC/D,CACF,CAEA,MAAM,WAAa,IAAI,MAAM,2BAA2B,CAC1D,CACF","names":[],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/audio/tts/openaiTts.ts"],"sourcesContent":[null]}}