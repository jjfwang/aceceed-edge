{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{promises as fs}from\"node:fs\";import{runCommand,sleep,tempPath}from\"../common/utils.js\";function pcmToWav(pcm,sampleRate,channels){const header=Buffer.alloc(44);const byteRate=sampleRate*channels*2;const blockAlign=channels*2;header.write(\"RIFF\",0);header.writeUInt32LE(36+pcm.length,4);header.write(\"WAVE\",8);header.write(\"fmt \",12);header.writeUInt32LE(16,16);header.writeUInt16LE(1,20);header.writeUInt16LE(channels,22);header.writeUInt32LE(sampleRate,24);header.writeUInt32LE(byteRate,28);header.writeUInt16LE(blockAlign,32);header.writeUInt16LE(16,34);header.write(\"data\",36);header.writeUInt32LE(pcm.length,40);return Buffer.concat([header,pcm])}__name(pcmToWav,\"pcmToWav\");class AudioInput{constructor(config,logger){this.config=config;this.logger=logger}static{__name(this,\"AudioInput\")}async record({signal,durationSec}){if(this.config.input.backend===\"node-record-lpcm16\"){try{const recordModule=await import(\"node-record-lpcm16\").then(s=>{const e=\"default\";return s[e]&&typeof s[e]==\"object\"&&\"__esModule\"in s[e]?s[e]:s});const recordExport=recordModule.default??recordModule;const recordFn=typeof recordExport===\"function\"?recordExport:recordExport.record;const recording=recordFn({sampleRate:this.config.input.sampleRate,channels:this.config.input.channels,device:this.config.input.device,recordProgram:\"arecord\",threshold:0});const chunks=[];let streamError=null;if(typeof recording.on===\"function\"){recording.on(\"error\",err=>{streamError=err})}const stream=recording.stream();stream.on(\"data\",data=>chunks.push(data));stream.on(\"error\",err=>{streamError=err});const waitForStreamEnd=__name(()=>new Promise(resolve=>{let settled=false;const finish=__name(()=>{if(settled){return}settled=true;resolve()},\"finish\");if(typeof stream.once===\"function\"){stream.once(\"close\",finish);stream.once(\"end\",finish);stream.once(\"error\",finish);return}if(typeof stream.on===\"function\"){stream.on(\"close\",finish);stream.on(\"end\",finish);stream.on(\"error\",finish);return}resolve()}),\"waitForStreamEnd\");const stop=__name(async()=>{const closed=waitForStreamEnd();recording.stop();await Promise.race([closed,sleep(500)]);if(typeof stream.destroy===\"function\"){stream.destroy()}if(streamError){throw streamError}},\"stop\");let aborted=false;const abortPromise=new Promise(resolve=>{if(!signal){return}if(signal.aborted){aborted=true;resolve();return}signal.addEventListener(\"abort\",()=>{aborted=true;void stop();resolve()})});await Promise.race([sleep(durationSec*1e3),abortPromise]);await stop();const pcm=Buffer.concat(chunks);if(aborted&&pcm.length===0){throw new Error(\"Recording aborted\")}const wav=pcmToWav(pcm,this.config.input.sampleRate,this.config.input.channels);const outPath2=tempPath(\"aceceed-ptt\",\".wav\");await fs.writeFile(outPath2,wav);return outPath2}catch(err){this.logger.warn({err},\"node-record-lpcm16 failed, falling back to arecord\")}}const outPath=tempPath(\"aceceed-ptt\",\".wav\");try{await runCommand(this.config.input.arecordPath,[\"-D\",this.config.input.device,\"-f\",\"S16_LE\",\"-r\",String(this.config.input.sampleRate),\"-c\",String(this.config.input.channels),\"-d\",String(durationSec),\"-t\",\"wav\",outPath],{signal})}catch(err){if(signal?.aborted){try{const stat=await fs.stat(outPath);if(stat.size>44){return outPath}}catch{}}throw new Error(`Audio capture failed. Check input device '${this.config.input.device}'.`)}return outPath}}export{AudioInput};\n","warnings":[],"map":{"version":3,"mappings":"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","names":["outPath"],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/audio/input.ts"],"sourcesContent":[null]}}