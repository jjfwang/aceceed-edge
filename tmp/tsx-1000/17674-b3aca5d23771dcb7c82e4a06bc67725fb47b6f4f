{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{fileURLToPath}from\"node:url\";import{readTextFile}from\"./common/utils.js\";import{loadConfig}from\"./common/config.js\";import{createLogger}from\"./common/logging.js\";import{EventBus}from\"./runtime/eventBus.js\";import{AudioInput}from\"./audio/input.js\";import{AudioOutput}from\"./audio/output.js\";import{OpenAiWhisperStt}from\"./audio/stt/openaiWhisper.js\";import{WhisperCppStt}from\"./audio/stt/whisperCpp.js\";import{OpenAiTts}from\"./audio/tts/openaiTts.js\";import{PiperTts}from\"./audio/tts/piper.js\";import{LocalLlamaCppClient}from\"./llm/localLlamaCpp.js\";import{OpenAiClient}from\"./llm/openaiApi.js\";import{Llm8850Client}from\"./llm/llm8850Api.js\";import{TutorAgent}from\"./agents/tutorAgent.js\";import{CoachAgent}from\"./agents/coachAgent.js\";import{AgentRegistry}from\"./agents/registry.js\";import{VisionCapture}from\"./vision/capture.js\";import{SimpleActivityDetector}from\"./vision/detectors/simpleActivity.js\";import{HailoStubDetector}from\"./vision/detectors/hailoStub.js\";import{AppRuntime}from\"./runtime/appRuntime.js\";import{startWhisplayPtt}from\"./runtime/whisplayPtt.js\";import{startWhisplayDisplay}from\"./runtime/whisplayDisplay.js\";import{createServer}from\"./api/server.js\";import{LocalRagRetriever}from\"./rag/localStore.js\";import{VisionOcr}from\"./vision/ocr.js\";function setupKeyboard(bus2,logger2){if(!process.stdin.isTTY){logger2.warn(\"Keyboard PTT disabled: no TTY attached\");return}let active=false;process.stdin.setRawMode(true);process.stdin.resume();process.stdin.on(\"data\",data=>{const key=data.toString();if(key===\" \"){active=!active;bus2.publish({type:active?\"ptt:start\":\"ptt:stop\",source:\"keyboard\"})}if(key===\"\u0003\"){process.exit(0)}});logger2.info(\"Keyboard PTT: press SPACE to start/stop recording\")}__name(setupKeyboard,\"setupKeyboard\");const config=await loadConfig();const logger=createLogger(config.logging);const bus=new EventBus;const audioInput=new AudioInput(config.audio,logger);const audioOutput=new AudioOutput(config.audio,logger);const stt=config.stt.mode===\"cloud\"?new OpenAiWhisperStt(config.stt,logger):new WhisperCppStt(config.stt,logger);const tts=config.tts.mode===\"cloud\"?new OpenAiTts(config.tts,logger):new PiperTts(config.tts,logger);const localBackend=config.llm.local.backend??\"llama.cpp\";const llm=config.llm.mode===\"cloud\"?new OpenAiClient(config.llm,logger):localBackend===\"llm8850\"?new Llm8850Client(config.llm,logger):new LocalLlamaCppClient(config.llm,logger);const promptUrl=new URL(\"./llm/prompts/systemPrompt.txt\",import.meta.url);const systemPrompt=await readTextFile(fileURLToPath(promptUrl));logger.info({systemPrompt},\"Loaded system prompt\");const coachPromptUrl=new URL(\"./llm/prompts/coachPrompt.txt\",import.meta.url);const coachPrompt=await readTextFile(fileURLToPath(coachPromptUrl));logger.info({coachPrompt},\"Loaded coach prompt\");const tutorAgent=new TutorAgent(llm,systemPrompt,logger);const coachAgent=new CoachAgent(llm,coachPrompt,logger);const enabledAgents=config.runtime.agents?.enabled??[\"tutor\"];const registry=new AgentRegistry([tutorAgent,coachAgent],enabledAgents);const vision=new VisionCapture(config.vision,logger);const detectors=[new SimpleActivityDetector,new HailoStubDetector];const ragRetriever=config.rag.enabled===true?new LocalRagRetriever(config.rag.indexPath,logger):void 0;if(ragRetriever){await ragRetriever.init()}const ocr=config.vision.ocr?.enabled?new VisionOcr(config.vision.ocr,logger):void 0;const runtime=new AppRuntime(config,logger,bus,audioInput,audioOutput,stt,tts,registry,vision,detectors,ragRetriever,ocr);runtime.start();if(config.runtime.pushToTalkMode===\"keyboard\"){setupKeyboard(bus,logger)}const server=createServer(config,runtime,bus);try{await server.listen({host:config.api.host,port:config.api.port});logger.info(`API listening on http://${config.api.host}:${config.api.port}`);let stopWhisplay;let stopDisplay;if(config.runtime.pushToTalkMode===\"whisplay\"){stopWhisplay=await startWhisplayPtt(bus,config,logger);stopDisplay=startWhisplayDisplay(bus,config,logger)}let shuttingDown=false;const shutdown=__name(async signal=>{if(shuttingDown){return}shuttingDown=true;logger.info({signal},\"Shutting down\");try{stopWhisplay?.();stopDisplay?.();await server.close()}catch(err){logger.error({err},\"Shutdown failed\")}finally{process.exit(0)}},\"shutdown\");process.on(\"SIGINT\",()=>{void shutdown(\"SIGINT\")});process.on(\"SIGTERM\",()=>{void shutdown(\"SIGTERM\")})}catch(err){logger.error({err},\"Failed to start API server\");process.exit(1)}\n","warnings":[],"map":{"version":3,"mappings":"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","names":["bus","logger"],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/main.ts"],"sourcesContent":[null]}}