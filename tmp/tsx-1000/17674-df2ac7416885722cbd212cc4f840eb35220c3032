{"code":"var __defProp=Object.defineProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});import{promises as fs}from\"node:fs\";import path from\"node:path\";function tokenize(text){return text.toLowerCase().replace(/[^a-z0-9\\u4e00-\\u9fff\\s]/gi,\" \").split(/\\s+/).filter(Boolean)}__name(tokenize,\"tokenize\");function scoreChunk(queryTokens,chunk){const tagText=chunk.tags?.join(\" \")??\"\";const haystack=tokenize(`${chunk.content} ${chunk.topic} ${chunk.subject} ${tagText}`);let hits=0;for(const token of queryTokens){if(haystack.includes(token)){hits+=1}}return hits/Math.max(haystack.length,1)}__name(scoreChunk,\"scoreChunk\");class LocalRagRetriever{constructor(indexPath,logger){this.indexPath=indexPath;this.logger=logger}static{__name(this,\"LocalRagRetriever\")}chunks=[];async init(){const candidates=[path.resolve(this.indexPath),path.resolve(process.cwd(),this.indexPath),path.resolve(process.cwd(),\"..\",this.indexPath)];let data=null;let resolved=\"\";let lastError=null;for(const candidate of candidates){try{data=await fs.readFile(candidate);resolved=candidate;break}catch(err){lastError=err;continue}}if(!data){throw new Error(`RAG index not found. Tried: ${candidates.join(\", \")}. Last error: ${lastError?.message??\"unknown\"}`)}try{const parsed=JSON.parse(data.toString());this.chunks=parsed}catch(err){throw new Error(`Failed to parse RAG index at ${resolved}: ${err.message}`)}if(this.logger){this.logger.info({count:this.chunks.length,indexPath:resolved},\"Loaded RAG curriculum index\")}}async retrieve(query,options){if(!this.chunks.length){return[]}const queryTokens=tokenize(query);const filtered=this.chunks.filter(chunk=>chunk.gradeBand===options.gradeBand&&(options.subjects.length===0||options.subjects.includes(chunk.subject))&&(!options.sourceTypes?.length||chunk.sourceType&&options.sourceTypes.includes(chunk.sourceType)));const scored=filtered.map(chunk=>({chunk,score:scoreChunk(queryTokens,chunk)})).sort((a,b)=>b.score-a.score).slice(0,options.limit).map(({chunk})=>chunk);if(!options.includeSources){return scored.map(({source,...rest})=>rest)}return scored}}export{LocalRagRetriever};\n","warnings":[],"map":{"version":3,"mappings":"kHAAA,OAAS,YAAY,OAAU,UAC/B,OAAO,SAAU,YASjB,SAAS,SAAS,KAAwB,CACxC,OAAO,KACJ,YAAY,EACZ,QAAQ,6BAA8B,GAAG,EACzC,MAAM,KAAK,EACX,OAAO,OAAO,CACnB,CANS,4BAQT,SAAS,WAAW,YAAuB,MAAyB,CAClE,MAAM,QAAU,MAAM,MAAM,KAAK,GAAG,GAAK,GACzC,MAAM,SAAW,SAAS,GAAG,MAAM,OAAO,IAAI,MAAM,KAAK,IAAI,MAAM,OAAO,IAAI,OAAO,EAAE,EACvF,IAAI,KAAO,EACX,UAAW,SAAS,YAAa,CAC/B,GAAI,SAAS,SAAS,KAAK,EAAG,CAC5B,MAAQ,CACV,CACF,CACA,OAAO,KAAO,KAAK,IAAI,SAAS,OAAQ,CAAC,CAC3C,CAVS,gCAYF,MAAM,iBAA0C,CAGrD,YAAoB,UAA2B,OAAiB,CAA5C,yBAA2B,kBAAkB,CAjCnE,MA8BuD,kCAC7C,OAAqB,CAAC,EAI9B,MAAM,MAAsB,CAC1B,MAAM,WAAa,CACjB,KAAK,QAAQ,KAAK,SAAS,EAC3B,KAAK,QAAQ,QAAQ,IAAI,EAAG,KAAK,SAAS,EAC1C,KAAK,QAAQ,QAAQ,IAAI,EAAG,KAAM,KAAK,SAAS,CAClD,EACA,IAAI,KAAsB,KAC1B,IAAI,SAAW,GACf,IAAI,UAA0B,KAE9B,UAAW,aAAa,WAAY,CAClC,GAAI,CACF,KAAO,MAAM,GAAG,SAAS,SAAS,EAClC,SAAW,UACX,KACF,OAAS,IAAK,CACZ,UAAY,IACZ,QACF,CACF,CAEA,GAAI,CAAC,KAAM,CACT,MAAM,IAAI,MACR,+BAA+B,WAAW,KAAK,IAAI,CAAC,iBAAiB,WAAW,SAAW,SAAS,EACtG,CACF,CAEA,GAAI,CACF,MAAM,OAAS,KAAK,MAAM,KAAK,SAAS,CAAC,EACzC,KAAK,OAAS,MAChB,OAAS,IAAK,CACZ,MAAM,IAAI,MAAM,gCAAgC,QAAQ,KAAM,IAAc,OAAO,EAAE,CACvF,CACA,GAAI,KAAK,OAAQ,CACf,KAAK,OAAO,KACV,CAAE,MAAO,KAAK,OAAO,OAAQ,UAAW,QAAS,EACjD,6BACF,CACF,CACF,CAEA,MAAM,SACJ,MACA,QAOqB,CACrB,GAAI,CAAC,KAAK,OAAO,OAAQ,CACvB,MAAO,CAAC,CACV,CACA,MAAM,YAAc,SAAS,KAAK,EAClC,MAAM,SAAW,KAAK,OAAO,OAC1B,OACC,MAAM,YAAc,QAAQ,YAC3B,QAAQ,SAAS,SAAW,GAAK,QAAQ,SAAS,SAAS,MAAM,OAAO,KACxE,CAAC,QAAQ,aAAa,QAAW,MAAM,YAAc,QAAQ,YAAY,SAAS,MAAM,UAAU,EACvG,EACA,MAAM,OAAS,SACZ,IAAK,QAAW,CAAE,MAAO,MAAO,WAAW,YAAa,KAAK,CAAE,EAAE,EACjE,KAAK,CAAC,EAAG,IAAM,EAAE,MAAQ,EAAE,KAAK,EAChC,MAAM,EAAG,QAAQ,KAAK,EACtB,IAAI,CAAC,CAAE,KAAM,IAAM,KAAK,EAE3B,GAAI,CAAC,QAAQ,eAAgB,CAC3B,OAAO,OAAO,IAAI,CAAC,CAAE,OAAQ,GAAG,IAAK,IAAM,IAAI,CACjD,CACA,OAAO,MACT,CACF","names":[],"ignoreList":[],"sources":["/home/pi/aceceed-edge/apps/src/rag/localStore.ts"],"sourcesContent":[null]}}